{% extends "cogsapp/base.html" %}
{% block content %}
<div class="container">
  <h1 class="mt-3">Calculateur COGS</h1>

  <form method="post" id="cogsForm">
    {% csrf_token %}
    <div class="row g-2 mb-2">
      <div class="col-md-2">
        <label>Total kg</label>
        <input class="form-control" type="number" name="total_kg" id="total_kg" step="0.01" required value="{{ result.total_materials|default:'' }}">
      </div>
      <div class="col-md-2">
        <label>Labor ($)</label>
        <input class="form-control" type="number" name="labor_cost" step="0.01" value="{{ result.labor_cost|default:35 }}">
      </div>
      <div class="col-md-2">
        <label>Energy ($)</label>
        <input class="form-control" type="number" name="energy_cost" step="0.01" value="{{ result.energy_cost|default:12 }}">
      </div>
      <div class="col-md-2">
        <label>Packaging ($)</label>
        <input class="form-control" type="number" name="packaging_cost" step="0.01" value="{{ result.packaging_cost|default:22 }}">
      </div>
      <div class="col-md-2">
        <label>Overhead (%)</label>
        <input class="form-control" type="number" name="overhead_percent" step="0.01" value="{{ result.overhead_cost|default:8 }}">
      </div>
      <div class="col-md-2">
        <label>Margin (%)</label>
        <input class="form-control" type="number" name="margin_percent" step="0.01" value="{{ result.margin_percent|default:25 }}">
      </div>
    </div>

    <div class="my-2">
      <label>Choisir une recette (optionnel)</label>
      <select name="recipe_id" class="form-select">
        <option value="">-- aucune --</option>
        {% for r in recipes %}
        <option value="{{ r.id }}" {% if result.recipe_id == r.id|stringformat:"s" %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <hr>
    <h5>Composants (si vide, la recette sélectionnée sera utilisée)</h5>
    <div id="rows">
      <div class="row mb-2">
        <div class="col"><input class="form-control" name="name[]" placeholder="Nom"></div>
        <div class="col"><input class="form-control" name="percent[]" placeholder="%" type="number" step="0.01"></div>
        <div class="col"><input class="form-control" name="price[]" placeholder="Prix/kg" type="number" step="0.01"></div>
      </div>
    </div>

    <button type="button" class="btn btn-secondary btn-sm" onclick="addRow()">+ Ajouter ligne</button>
    <button type="submit" class="btn btn-primary">Calculer{{ result.saved|default:'' }}</button>

    {% if result and result.saved %}
      <a href="{% url 'export_production_excel' result.production_id %}" class="btn btn-success ms-2">Exporter Excel</a>
      <a href="{% url 'export_production_pdf' result.production_id %}" class="btn btn-danger ms-2">Exporter PDF</a>
    {% endif %}

  </form>

  {% if result %}
  <hr>
  <h3>Résultats</h3>

  <table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr><th>Nom</th><th>%</th><th>Kg</th><th>Prix/kg</th><th>Coût</th></tr>
    </thead>
    <tbody>
      {% for ing in result.ingredients %}
      <tr>
        <td>{{ ing.name }}</td>
        <td>{{ ing.percent }}</td>
        <td>{{ ing.kg }}</td>
        <td>{{ ing.price }}</td>
        <td>{{ ing.cost }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <ul>
    <li>Total matières : <strong>{{ result.total_materials }}</strong></li>
    <li>Labor : <strong>{{ result.labor_cost }}</strong></li>
    <li>Energy : <strong>{{ result.energy_cost }}</strong></li>
    <li>Packaging : <strong>{{ result.packaging_cost }}</strong></li>
    <li>Overhead : <strong>{{ result.overhead_cost }}</strong></li>
    <li>COGS total : <strong>{{ result.cogs_total }}</strong></li>
    <li>Cost/kg : <strong>{{ result.cost_per_kg }}</strong></li>
    <li>Margin (%) : <strong>{{ result.margin_percent }}</strong></li>
    <li>Price/kg : <strong>{{ result.price_per_kg }}</strong></li>
    <li>Price total : <strong>{{ result.price_total }}</strong></li>
  </ul>
  {% endif %}
</div>

<script>
function addRow(){
  const rows = document.getElementById('rows');
  const div = document.createElement('div');
  div.className = 'row mb-2';
  div.innerHTML = `<div class="col"><input class="form-control" name="name[]" placeholder="Nom"></div>
                   <div class="col"><input class="form-control" name="percent[]" placeholder="%" type="number" step="0.01"></div>
                   <div class="col"><input class="form-control" name="price[]" placeholder="Prix/kg" type="number" step="0.01"></div>`;
  rows.appendChild(div);
}
</script>
{% endblock %}